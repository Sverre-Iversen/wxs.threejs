<!doctype html>

<html>
<head>
<title>sjo</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
body { margin: 0; overflow: hidden; }
</style>
</head>
<body>
<div id="webgl" style="background-color:#ccccff"></div>
<script src="./three.min.js"></script>
<script src="./TrackballControls.js"></script>

<script>
      function getQueryVariable(variable){
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return pair[1];}
        }
        return(false);
    }
  var width  = window.innerWidth;
  var height = window.innerHeight;
  var demWidth=getQueryVariable("width")||200;
  var demHeight=getQueryVariable("height")||200;

  var bbox=getQueryVariable("bbox")||'99975,6799975,200025,6900025';

  var metersWidth=bbox.split(',')[2]-bbox.split(',')[0];
  var metersHeight=bbox.split(',')[3]-bbox.split(',')[1];

  var proportionWidth=metersWidth/demWidth;
  var proportionHeight=metersHeight/demHeight;
  var proportionAverage=1/((proportionWidth+proportionHeight)/2);
  var zInv=getQueryVariable("zInv")||false;
  if (zInv){
      proportionAverage=proportionAverage*-1;
  }
  var zMult=getQueryVariable("zmult");
  if (zMult){
    zMult=proportionAverage*zMult;
  }
  else
  {
      zMult=proportionAverage;
  }
  var crs=getQueryVariable("crs")||'EPSG:32633';
  var coverage=getQueryVariable("coverage")||'land_utm33_50m';
  var wms=getQueryVariable("wms")||'http://wms.geonorge.no/skwms1/wms.topo2';
  var layers=getQueryVariable("layers")||'topo2_wms';
  var renderer = new THREE.WebGLRenderer();
  renderer.setSize(width, height);

  var scene = new THREE.Scene();
  scene.add(new THREE.AmbientLight(0xeeeeee));

  var camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
  camera.position.set(0, -100, 100);

  var controls = new THREE.TrackballControls(camera);
  
  var geometry = new THREE.PlaneGeometry(demWidth, demHeight, demWidth-1, demHeight-1);
  var lines=new Array();
  var dem=new XMLHttpRequest();
  dem.open('GET','http://wcs.geonorge.no/skwms1/wcs.dtm?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&FORMAT=XYZ&COVERAGE='+coverage+'&bbox='+bbox+'&CRS='+crs+'&RESPONSE_CRS='+crs+'&WIDTH='+demWidth+'&HEIGHT='+demHeight);
   
   dem.onreadystatechange = function() {
         if(dem.readyState==4){
           window.lines= dem.responseText.split("\n");
           for (var i = 0, l = geometry.vertices.length; i < l; i++) {
                window.geometry.vertices[i].z = (window.lines[i].split(' ')[2]*zMult);                
            }
            window.render();
       }
   }
  dem.send();


  var material = new THREE.MeshPhongMaterial({ map: THREE.ImageUtils.loadTexture(wms+'?service=wms&version=1.3.0&request=getmap&crs='+crs+'&srs='+crs+'&WIDTH='+demWidth*10+'&HEIGHT='+demHeight*10+'&bbox='+bbox+'&layers='+layers+'&format=image/png')
        });
  var plane = new THREE.Mesh(geometry, material);
  scene.add(plane);

  document.getElementById('webgl').appendChild(renderer.domElement);
  //render();

  function render() {
    controls.update();  
    requestAnimationFrame(render);
    renderer.render(scene, camera);
  }

</script>
</body>
</html>
